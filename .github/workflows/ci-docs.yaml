name: CI-build-docs

on:
  push:
    branches: [ master, documentation ]
  pull_request: # no filters on pull requests

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Get Token
        uses: cmagovuk/github-app-installation-token-action@v2
        id: installationToken
        with: 
          appId: ${{ secrets.TALOS_V2_APP_ID }}
          installationId: ${{secrets.TALOS_V2_INSTALLATION_ID }}
          privateKey: ${{ secrets.TALOS_V2_PRIVATE_KEY }}
      - name: Setup git
        run: |
          git config --global url."https://x-access-token:${{ steps.installationToken.outputs.token }}@github.com/".insteadOf "https://github.com/"
          git config --global url."https://x-access-token:${{ steps.installationToken.outputs.token }}@github.com/".insteadOf "git@github.com:"
      - name: Install pandoc
        run: |
          sudo apt-get install pandoc
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.9
      - name: Install requirements
        run: |
          cd docs
          make requirements
      - name: Make documentation HTML
        run: |
          cd docs
          make html
      # NOTE could use https://github.com/peaceiris/actions-gh-pages
      - name: Commit documentation changes
        if: github.event_name == 'push'
        run: |
          rm -r ~/.gitconfig
          git config --global user.email "you@example.com"
          git config --global user.name "GithubAction"
          git config --global url."https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"
          git add -f .
          git commit -m "Update documentation"
          git push -f origin HEAD:docs
